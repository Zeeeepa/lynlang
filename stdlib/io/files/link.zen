// Zen Standard Library: Link Operations (Syscall-based)
// No FFI - uses compiler.syscall* intrinsics
// symlink, readlink, unlink, link, rename

{ compiler } = @std
{ Result } = @std.core.result

// ============================================================================
// Syscall Numbers (x86-64)
// ============================================================================

SYS_LINK = 86
SYS_UNLINK = 87
SYS_SYMLINK = 88
SYS_READLINK = 89
SYS_RENAME = 82
SYS_LINKAT = 265
SYS_UNLINKAT = 263
SYS_SYMLINKAT = 266
SYS_READLINKAT = 267
SYS_RENAMEAT = 264
SYS_RENAMEAT2 = 316

// ============================================================================
// Constants
// ============================================================================

AT_FDCWD = -100              // Current working directory
AT_REMOVEDIR = 512           // Remove directory (for unlinkat)
AT_SYMLINK_FOLLOW = 1024     // Follow symlinks

// Rename flags (renameat2)
RENAME_NOREPLACE = 1         // Don't overwrite target
RENAME_EXCHANGE = 2          // Exchange source and target
RENAME_WHITEOUT = 4          // Whiteout source (overlay fs)

// ============================================================================
// Hard Links
// ============================================================================

// Create a hard link
link = (old_path: i64, new_path: i64) Result<(), i32> {
    result = compiler.syscall2(SYS_LINK, old_path, new_path)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Create hard link relative to directory fds
linkat = (old_dirfd: i32, old_path: i64, new_dirfd: i32, new_path: i64, flags: i32) Result<(), i32> {
    result = compiler.syscall5(SYS_LINKAT, old_dirfd, old_path, new_dirfd, new_path, flags)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// ============================================================================
// Symbolic Links
// ============================================================================

// Create a symbolic link
symlink = (target: i64, link_path: i64) Result<(), i32> {
    result = compiler.syscall2(SYS_SYMLINK, target, link_path)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Create symbolic link relative to directory fd
symlinkat = (target: i64, dirfd: i32, link_path: i64) Result<(), i32> {
    result = compiler.syscall3(SYS_SYMLINKAT, target, dirfd, link_path)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Read the target of a symbolic link
// Returns number of bytes written to buf (not null-terminated)
readlink = (path: i64, buf: i64, buf_size: usize) Result<usize, i32> {
    result = compiler.syscall3(SYS_READLINK, path, buf, buf_size)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(result as usize)
}

// Read symlink relative to directory fd
readlinkat = (dirfd: i32, path: i64, buf: i64, buf_size: usize) Result<usize, i32> {
    result = compiler.syscall4(SYS_READLINKAT, dirfd, path, buf, buf_size)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(result as usize)
}

// ============================================================================
// Unlink (Delete)
// ============================================================================

// Remove a file
unlink = (path: i64) Result<(), i32> {
    result = compiler.syscall1(SYS_UNLINK, path)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Remove file or directory relative to directory fd
unlinkat = (dirfd: i32, path: i64, flags: i32) Result<(), i32> {
    result = compiler.syscall3(SYS_UNLINKAT, dirfd, path, flags)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Remove a file (convenience - alias for unlink)
remove_file = (path: i64) Result<(), i32> {
    return unlink(path)
}

// Remove an empty directory
remove_dir = (path: i64) Result<(), i32> {
    return unlinkat(AT_FDCWD, path, AT_REMOVEDIR)
}

// ============================================================================
// Rename
// ============================================================================

// Rename/move a file or directory
rename = (old_path: i64, new_path: i64) Result<(), i32> {
    result = compiler.syscall2(SYS_RENAME, old_path, new_path)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Rename relative to directory fds
renameat = (old_dirfd: i32, old_path: i64, new_dirfd: i32, new_path: i64) Result<(), i32> {
    result = compiler.syscall4(SYS_RENAMEAT, old_dirfd, old_path, new_dirfd, new_path)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Rename with flags (RENAME_NOREPLACE, RENAME_EXCHANGE)
renameat2 = (old_dirfd: i32, old_path: i64, new_dirfd: i32, new_path: i64, flags: u32) Result<(), i32> {
    result = compiler.syscall5(SYS_RENAMEAT2, old_dirfd, old_path, new_dirfd, new_path, flags)
    result < 0 ? { return Result.Err(result as i32) }
    return Result.Ok(())
}

// Rename without overwriting existing target
rename_noreplace = (old_path: i64, new_path: i64) Result<(), i32> {
    return renameat2(AT_FDCWD, old_path, AT_FDCWD, new_path, RENAME_NOREPLACE)
}

// Atomically exchange two paths
rename_exchange = (path_a: i64, path_b: i64) Result<(), i32> {
    return renameat2(AT_FDCWD, path_a, AT_FDCWD, path_b, RENAME_EXCHANGE)
}

// ============================================================================
// Convenience Functions
// ============================================================================

// Move a file (alias for rename)
move_file = (from: i64, to: i64) Result<(), i32> {
    return rename(from, to)
}

// Copy symlink target to buffer and null-terminate
// Returns length of target (not including null)
readlink_z = (path: i64, buf: i64, buf_size: usize) Result<usize, i32> {
    buf_size == 0 ? { return Result.Err(-22) }  // EINVAL

    // Read with one less byte for null terminator
    result = readlink(path, buf, buf_size - 1)
    result ? {
        | Ok(len) {
            // Null terminate
            compiler.store<u8>(compiler.int_to_ptr(buf + len as i64), 0)
            return Result.Ok(len)
        }
        | Err(e) { return Result.Err(e) }
    }
}
