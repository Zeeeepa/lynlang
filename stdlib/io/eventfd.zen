// Zen Standard Library: Eventfd (Syscall-based)
// No FFI - uses compiler.syscall* intrinsics
// Event notification file descriptor

{ compiler } = @std
{ Result } = @std.core.result
{ SYS_EVENTFD2, SYS_READ, SYS_WRITE, SYS_CLOSE } = @std.sys.syscall

// Eventfd flags
EFD_CLOEXEC = 524288
EFD_NONBLOCK = 2048
EFD_SEMAPHORE = 1

EventfdError: { code: i32 }

EventfdError.from_errno = (errno: i64) EventfdError {
    return EventfdError { code: (0 - errno) as i32 }
}

Eventfd: { fd: i32 }

// Create eventfd with initial value
Eventfd.new = (initval: u32) Result<Eventfd, EventfdError> {
    result = compiler.syscall2(SYS_EVENTFD2, initval, EFD_CLOEXEC)
    result < 0 ? { return Result.Err(EventfdError.from_errno(result)) }
    return Result.Ok(Eventfd { fd: result as i32 })
}

// Create semaphore-like eventfd
Eventfd.semaphore = (initval: u32) Result<Eventfd, EventfdError> {
    result = compiler.syscall2(SYS_EVENTFD2, initval, EFD_CLOEXEC | EFD_SEMAPHORE)
    result < 0 ? { return Result.Err(EventfdError.from_errno(result)) }
    return Result.Ok(Eventfd { fd: result as i32 })
}

// Read counter (blocks if 0, resets to 0 or decrements for semaphore)
Eventfd.read = (self: MutPtr<Eventfd>) Result<u64, EventfdError> {
    value: u64 = 0
    result = compiler.syscall3(SYS_READ, self.val.fd, compiler.ptr_to_int(&value.ref()), 8)
    result < 0 ? { return Result.Err(EventfdError.from_errno(result)) }
    return Result.Ok(value)
}

// Add to counter (wakes waiters)
Eventfd.write = (self: MutPtr<Eventfd>, value: u64) Result<(), EventfdError> {
    result = compiler.syscall3(SYS_WRITE, self.val.fd, compiler.ptr_to_int(&value.ref()), 8)
    result < 0 ? { return Result.Err(EventfdError.from_errno(result)) }
    return Result.Ok(())
}

// Signal (add 1)
Eventfd.signal = (self: MutPtr<Eventfd>) Result<(), EventfdError> {
    return self.write(1)
}

// Wait (read and discard)
Eventfd.wait = (self: MutPtr<Eventfd>) Result<(), EventfdError> {
    self.read().raise()
    return Result.Ok(())
}

Eventfd.close = (self: MutPtr<Eventfd>) void {
    compiler.syscall1(SYS_CLOSE, self.val.fd)
}
