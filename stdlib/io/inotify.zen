// Zen Standard Library: Inotify File Watching (Syscall-based)
// No FFI - uses compiler.syscall* intrinsics

{ compiler } = @std
{ Result } = @std.core.result
{ SYS_INOTIFY_INIT1, SYS_INOTIFY_ADD_WATCH, SYS_INOTIFY_RM_WATCH, SYS_READ, SYS_CLOSE } = @std.sys.syscall

IN_CLOEXEC = 524288
IN_NONBLOCK = 2048

// Watch events
IN_ACCESS = 1
IN_MODIFY = 2
IN_ATTRIB = 4
IN_CLOSE_WRITE = 8
IN_CLOSE_NOWRITE = 16
IN_OPEN = 32
IN_MOVED_FROM = 64
IN_MOVED_TO = 128
IN_CREATE = 256
IN_DELETE = 512
IN_DELETE_SELF = 1024
IN_MOVE_SELF = 2048
IN_ALL_EVENTS = 4095

InotifyError: { code: i32 }
InotifyError.from_errno = (errno: i64) InotifyError { return InotifyError { code: (0 - errno) as i32 } }

Inotify: { fd: i32 }

Inotify.new = () Result<Inotify, InotifyError> {
    result = compiler.syscall1(SYS_INOTIFY_INIT1, IN_CLOEXEC)
    result < 0 ? { return Result.Err(InotifyError.from_errno(result)) }
    return Result.Ok(Inotify { fd: result as i32 })
}

Inotify.add_watch = (self: MutPtr<Inotify>, path_ptr: i64, mask: u32) Result<i32, InotifyError> {
    result = compiler.syscall3(SYS_INOTIFY_ADD_WATCH, self.val.fd, path_ptr, mask)
    result < 0 ? { return Result.Err(InotifyError.from_errno(result)) }
    return Result.Ok(result as i32)
}

Inotify.rm_watch = (self: MutPtr<Inotify>, wd: i32) Result<(), InotifyError> {
    result = compiler.syscall2(SYS_INOTIFY_RM_WATCH, self.val.fd, wd)
    result < 0 ? { return Result.Err(InotifyError.from_errno(result)) }
    return Result.Ok(())
}

Inotify.close = (self: MutPtr<Inotify>) void { compiler.syscall1(SYS_CLOSE, self.val.fd) }
