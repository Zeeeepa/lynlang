// test.zen - Test suite for the Zen full example project
// This file demonstrates how to write tests in Zen

{ print, println } = @std.io
{ Option, Result } = @std
{ HashMap, HashSet } = @std.collections
{ Vec, DynVec, Array } = @std
{ memory } = @std

// Import the test framework from stdlib
{ TestResult, TestSuite, new_test_suite, add_test, run_tests } = @std.testing.runner

// Import the main module functions to test
// TODO: Import functions from main.zen once module imports are implemented
// For now, we define stubs that would normally come from main.zen
add = (a: i32, b: i32) i32 { return a + b }
divide = (a: i32, b: i32) Result<i32, StaticString> {
    b == 0 ?
        | true { return Result.Err("Division by zero") }
        | false { return Result.Ok(a / b) }
}

Status:
    Active,
    Inactive,
    Pending: i32

describe_status = (status: Status) StaticString {
    status ?
        | Active { return "Active" }
        | Inactive { return "Inactive" }
        | Pending(days) { return "Pending" }
}

// Stub for find_person - would normally come from main.zen
Person: {
    id: i32,
    name: StaticString
}

find_person = (id: i32) Option<Person> {
    id == 1 ?
        | true { return Option.Some(Person { id: 1, name: "Alice" }) }
        | false { return Option.None }
}

// Stub for calculate - would normally come from main.zen
calculate = () Result<f64, StaticString> {
    return Result.Ok(5.0)
}

// Generic container stub
Container<T>: {
    value: T,
    metadata: Option<StaticString>
}

// ============================================================================
// TEST CASES - Individual test functions
// ============================================================================

// Test basic arithmetic
test_add = () TestResult {
    result = add(5, 3)
    result == 8 ? {
        return TestResult.Pass
    }
    return TestResult.Fail("Expected 8, got ${result}")
}

// Test division with valid input
test_divide_valid = () TestResult {
    result = divide(10.0, 2.0)
    result ?
        | Ok(value) {
            value == 5.0 ? {
                return TestResult.Pass
            }
            return TestResult.Fail("Expected 5.0, got ${value}")
        }
        | Err(msg) {
            return TestResult.Fail("Unexpected error: ${msg}")
    }
}

// Test division by zero
test_divide_by_zero = () TestResult {
    result = divide(10.0, 0.0)
    result ?
        | Ok(value) {
            return TestResult.Fail("Expected error for division by zero")
        }
        | Err(msg) {
            msg == "Division by zero" ? {
                return TestResult.Pass
            }
            return TestResult.Fail("Expected 'Division by zero', got '${msg}'")
    }
}

// Test person lookup
test_find_person_exists = () TestResult {
    person = find_person(1)
    person ?
        | Some(p) {
            p.name == "Alice" ? {
                return TestResult.Pass
            }
            return TestResult.Fail("Expected name 'Alice', got '${p.name}'")
        }
        | None {
            return TestResult.Fail("Expected to find person with id 1")
    }
}

// Test person lookup for non-existent person
test_find_person_not_exists = () TestResult {
    person = find_person(999)
    person ?
        | Some(p) {
            return TestResult.Fail("Expected None for non-existent person")
        }
        | None {
            return TestResult.Pass
    }
}

// Test status pattern matching
test_describe_status_active = () TestResult {
    status = Status.Active
    description = describe_status(status)
    description == "Active" ?
        | true { return TestResult.Pass }
        | false { return TestResult.Fail("Expected 'Active', got '${description}'") }
}

test_describe_status_inactive = () TestResult {
    status = Status.Inactive
    description = describe_status(status)
    description == "Inactive" ?
        | true { return TestResult.Pass }
        | false { return TestResult.Fail("Expected 'Inactive', got '${description}'") }
}

// Test error propagation
test_calculate_success = () TestResult {
    result = calculate()
    result ?
        | Ok(value) {
            value == 5.0 ? {
                return TestResult.Pass
            }
            return TestResult.Fail("Expected 5.0, got ${value}")
        }
        | Err(msg) {
            return TestResult.Fail("Unexpected error: ${msg}")
    }
}

// Test collections with allocators
test_collections = () TestResult {
    allocator = @std.get_default_allocator()

    // Test HashMap
    map = HashMap.new<StaticString, i32>(allocator)
    map.insert("test", 42)
    value = map.get("test")
    value ?
        | Some(v) {
            v == 42 ? {
                return TestResult.Pass
            }
            return TestResult.Fail("Expected 42, got ${v}")
        }
        | None {
            return TestResult.Fail("Expected to find key 'test'")
    }
}

// Test string operations
test_string_operations = () TestResult {
    text = "Hello World"
    upper = text.to_upper()
    upper == "HELLO WORLD" ? {
        return TestResult.Pass
    }
    return TestResult.Fail("Expected 'HELLO WORLD', got '${upper}'")
}

// Test generic container
test_generic_container = () TestResult {
    container = Container<i32> {
        value: 100,
        metadata: Option.Some("test")
    }
    container.value == 100 ? {
        return TestResult.Pass
    }
    return TestResult.Fail("Expected value 100, got ${container.value}")
}

// ============================================================================
// MAIN TEST RUNNER
// ============================================================================

main = () void {
    println("=== ZEN TEST SUITE ===")

    // Get an allocator for the test suite
    allocator = memory.get_default_allocator()

    // Create test suite
    suite = new_test_suite("Zen Full Example Tests", allocator)

    // Add all tests
    add_test(suite, "Basic Addition", test_add)
    add_test(suite, "Division Valid", test_divide_valid)
    add_test(suite, "Division By Zero", test_divide_by_zero)
    add_test(suite, "Find Person Exists", test_find_person_exists)
    add_test(suite, "Find Person Not Exists", test_find_person_not_exists)
    add_test(suite, "Status Active", test_describe_status_active)
    add_test(suite, "Status Inactive", test_describe_status_inactive)
    add_test(suite, "Calculate Success", test_calculate_success)
    add_test(suite, "Collections", test_collections)
    add_test(suite, "String Operations", test_string_operations)
    add_test(suite, "Generic Container", test_generic_container)

    // Run all tests
    run_tests(suite)

    // Summary
    total = suite.passed + suite.failed
    println("\n=== TEST SUMMARY ===")
    println("Total tests: ${total}")
    println("Passed: ${suite.passed}")
    println("Failed: ${suite.failed}")

    suite.failed == 0 ?
        | true { println("üéâ All tests passed!") }
        | false { println("‚ùå Some tests failed") }
}
