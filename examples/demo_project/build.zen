// build.zen - Build configuration for the full example
// Uses the standard library build system

{ io, fs } = @std
{ build } = @std

// ============================================================================
// Build Configuration
// ============================================================================

configure = (is_release: bool) build.Build {
    io.println("Initializing build configuration...")

    fs.create_dir("build") ?
        | Ok(_) { io.println("  Created build/") }
        | Err(_) { io.println("  build/ exists") }

    b = build.new_build()

    is_release ?
        | true {
            io.println("Building in RELEASE mode")
            return build.Build(
            optimize: build.OptimizeMode.ReleaseFast,
            strip: true,
            enable_stack_traces: false,
            target: b.target,
            build_dir: b.build_dir,
            cache_dir: b.cache_dir,
            install_prefix: b.install_prefix
            )
        }
        | false {
            io.println("Building in DEBUG mode")
            return b
    }
}

setup_targets = (b: build.Build) void {
    io.println("\nConfiguring build targets...")

    // Create main executable
    exe = build.add_executable(b, build.ExeOptions {
        name: "zen_demo",
        root_source_file: "main.zen",
        link_libc: true
    })

    // Add test executable
    build.add_test(b, "test.zen")

    // Add static library
    utils_lib = build.add_static_library(b, build.LibOptions {
        name: "zen_utils",
        root_source_file: "utils.zen",
        version: build.Version { major: 1, minor: 0, patch: 0 }
    })

    // Add dependency
    build.add_dependency(b, "system", build.DepOptions { url: "system://libc" })

    // OS-specific configuration
    io.println("\nOS-specific configuration:")
    b.target.os_tag ?
        | Linux {
            build.link_system_library(exe, "c")
            build.link_system_library(exe, "m")
            io.println("  Linux: linked libc and libm")
        }
        | Macos {
            build.link_framework(exe, "Foundation")
            io.println("  macOS: linked Foundation framework")
        }
        | Windows {
            build.link_system_library(exe, "kernel32")
            io.println("  Windows: linked system libraries")
        }
        | _ {
            build.link_system_library(exe, "c")
    }

    // Define symbols
    io.println("\nDefining symbols:")
    build.define_symbol(exe, "ZEN_VERSION", "1.0.0")

    // Install artifacts
    io.println("\nInstalling artifacts:")
    build.install_artifact(b, exe)
    build.install_library(b, utils_lib)
}

// ============================================================================
// Main Entry Point
// ============================================================================

main = () i32 {
    io.println("=== ZEN BUILD SYSTEM ===\n")

    b = configure(false)

    io.println("\nTarget: ${build.os_name(b.target)}-${build.cpu_name(b.target)}")

    setup_targets(b)

    io.println("\n=== BUILD CONFIGURATION COMPLETE ===")

    return 0
}
