// FFI Demo - Dynamic Library Loading in Zen
//
// This example demonstrates loading a shared library at runtime
// and calling functions from it using compiler intrinsics.
//
// Note: For higher-level FFI with Result types, see stdlib/ffi/ffi.zen
// (requires additional compiler work for struct/Result integration)

{ io } = @std
{ compiler } = @std

main = () i32 {
    io.println("=== FFI Demo: Dynamic Library Loading ===")

    // Try loading libm (math library)
    // On Linux: libm.so.6, on macOS: libm.dylib
    lib = compiler.load_library("libm.so.6")

    compiler.is_null(lib) ?
        | true {
            io.println("Failed to load libm.so.6")
            err = compiler.dlerror()
            compiler.is_null(err) ?
                | true { io.println("No error message available") }
                | false { io.println("Error loading library") }
            return 1
        }
        | false {
            io.println("Successfully loaded libm.so.6")
    }

    // Look up the 'sin' function
    sin_ptr = compiler.get_symbol(lib, "sin")

    compiler.is_null(sin_ptr) ?
        | true {
            io.println("Failed to find 'sin' symbol")
            compiler.unload_library(lib)
            return 1
        }
        | false {
            io.println("Found 'sin' function at address")
            addr = compiler.ptr_to_int(sin_ptr)
            io.print_int(addr)
    }

    // Look up 'cos' function
    cos_ptr = compiler.get_symbol(lib, "cos")

    compiler.is_null(cos_ptr) ?
        | true {
            io.println("Failed to find 'cos' symbol")
        }
        | false {
            io.println("Found 'cos' function")
    }

    // Look up a non-existent symbol
    fake_ptr = compiler.get_symbol(lib, "this_does_not_exist")

    compiler.is_null(fake_ptr) ?
        | true {
            io.println("Correctly returned null for non-existent symbol")
        }
        | false {
            io.println("Unexpected: found non-existent symbol")
    }

    // Unload the library
    compiler.unload_library(lib)
    io.println("Library unloaded")

    io.println("=== FFI Demo Complete ===")
    return 0
}
