#!/usr/bin/env bash
# zen-check - Syntax validation tool for Zen language files
# Usage: zen-check [options] <file.zen>
# Version: 1.0.0

set -e

VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Handle command line arguments
if [ $# -eq 0 ]; then
    echo "Usage: zen-check [options] <file.zen>"
    echo "Options:"
    echo "  --version    Show version information"
    echo "  --help       Show this help message"
    exit 1
fi

# Check for version flag
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    echo "zen-check version $VERSION"
    exit 0
fi

# Check for help flag
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "zen-check - Syntax validation tool for Zen language files"
    echo "Version: $VERSION"
    echo ""
    echo "Usage: zen-check [options] <file.zen>"
    echo ""
    echo "Options:"
    echo "  -v, --version    Show version information"
    echo "  -h, --help       Show this help message"
    echo ""
    echo "Examples:"
    echo "  zen-check main.zen"
    echo "  zen-check examples/hello_world.zen"
    exit 0
fi

FILE="$1"

# Check if file exists
if [ ! -f "$FILE" ]; then
    echo -e "${RED}Error: File '$FILE' not found${NC}"
    exit 1
fi

# Check if it's a .zen file
if [[ ! "$FILE" == *.zen ]]; then
    echo -e "${YELLOW}Warning: File does not have .zen extension${NC}"
fi

# Get the directory of this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/.." && pwd )"

# Build the zen compiler if needed
if [ ! -f "$PROJECT_ROOT/target/debug/zen" ]; then
    echo -e "${YELLOW}Building Zen compiler...${NC}"
    (cd "$PROJECT_ROOT" && cargo build --quiet)
fi

# Run the syntax check
echo -e "${GREEN}Checking: $FILE${NC}"
OUTPUT=$("$PROJECT_ROOT/target/debug/zen" --check "$FILE" 2>&1) || {
    EXIT_CODE=$?
    echo -e "${RED}Syntax errors found:${NC}"
    echo "$OUTPUT"
    exit $EXIT_CODE
}

echo -e "${GREEN}âœ“ Syntax is valid${NC}"

# Check for import placement
if grep -q '@import\|comptime.*import\|fn.*import' "$FILE"; then
    # More detailed import checking
    if grep -q 'comptime.*import' "$FILE"; then
        echo -e "${YELLOW}Warning: Imports inside comptime blocks are not allowed${NC}"
        grep -n 'comptime.*import' "$FILE" | while read -r line; do
            echo "  Line $line"
        done
    fi
    
    if grep -q 'fn.*{.*import' "$FILE"; then
        echo -e "${YELLOW}Warning: Imports inside functions are not allowed${NC}"
        grep -n 'fn.*{.*import' "$FILE" | while read -r line; do
            echo "  Line $line"
        done
    fi
fi

# Check for common syntax patterns
echo ""
echo "File statistics:"
echo "  Lines: $(wc -l < "$FILE")"
echo "  Functions: $(grep -c '^[[:space:]]*\(fn\|.*=.*fn\)' "$FILE" || echo "0")"
echo "  Structs: $(grep -c '^[[:space:]]*struct' "$FILE" || echo "0")"
echo "  Imports: $(grep -c ':= @std\.' "$FILE" || echo "0")"